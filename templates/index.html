{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Candidate Tracker</h1>
    <div>
        <button type="button" class="btn btn-outline-secondary mr-2" data-toggle="modal" data-target="#countyProgressModal">
            <i class="fas fa-chart-bar"></i> County Progress
        </button>
        {% if is_super_admin %}
        <div class="btn-group mr-2">
            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown">
                <i class="fas fa-download"></i> Export
            </button>
            <div class="dropdown-menu dropdown-menu-right">
                <a class="dropdown-item" href="{{ url_for('export_csv', export_type='all_candidates') }}">All Candidates</a>
                <a class="dropdown-item" href="{{ url_for('export_csv', export_type='confirmed') }}">Confirmed Only</a>
                <a class="dropdown-item" href="{{ url_for('export_csv', export_type='potentials') }}">Potentials Only</a>
                <a class="dropdown-item" href="{{ url_for('export_csv', export_type='empty_districts') }}">Empty Districts</a>
                <a class="dropdown-item" href="{{ url_for('export_csv', export_type='by_county') }}">By County</a>
                <a class="dropdown-item" href="{{ url_for('export_csv', export_type='contact_list') }}">Contact List</a>
            </div>
        </div>
        {% endif %}
        <button class="btn btn-danger" onclick="openAddCandidateModal('', 2026)" style="background-color: #d91720; border-color: #d91720;">
            <i class="fas fa-plus"></i> Add Candidate
        </button>
    </div>
</div>

{% if county_filter %}
<div class="alert alert-info d-flex justify-content-between align-items-center">
    <span>Showing <strong>{{ county_filter|title }}</strong> County only</span>
    <a href="{{ url_for('index') }}" class="btn btn-sm btn-outline-secondary">Show All Counties</a>
</div>
{% endif %}

<!-- Dashboard Cards -->
<div class="dashboard-row mb-4">
    <a href="{{ url_for('filter_view', category='confirmed') }}" class="dash-card dash-card-size dash-card-link">
        <div class="card-header">Confirmed</div>
        <div class="card-body">
            <h4>{{ dashboard.confirmed.total }}</h4>
            <small class="text-muted">of {{ dashboard.TOTAL_SEATS }}</small>
        </div>
    </a>
    <a href="{{ url_for('filter_view', category='empty_districts') }}" class="dash-card dash-card-size dash-card-link">
        <div class="card-header">Empty Districts</div>
        <div class="card-body">
            <h4>{{ dashboard.empty_districts.total }}</h4>
        </div>
    </a>
    <a href="{{ url_for('filter_view', category='potentials') }}" class="dash-card dash-card-size dash-card-link">
        <div class="card-header">Potentials</div>
        <div class="card-body">
            <h4>{{ dashboard.potentials.total }}</h4>
        </div>
    </a>
    <a href="{{ url_for('filter_view', category='primaries') }}" class="dash-card dash-card-size dash-card-link">
        <div class="card-header">Primaries</div>
        <div class="card-body">
            <h4>{{ dashboard.primaries.total }}</h4>
        </div>
    </a>
    <a href="{{ url_for('filter_view', category='incumbents_undecided') }}" class="dash-card dash-card-size dash-card-link">
        <div class="card-header">Incumbents Undecided</div>
        <div class="card-body">
            <h4>{{ dashboard.incumbents_undecided.total }}</h4>
        </div>
    </a>
    <a href="{{ url_for('filter_view', category='unmatched_voters') }}" class="dash-card dash-card-size dash-card-link">
        <div class="card-header">Unmatched</div>
        <div class="card-body">
            <h4>{{ dashboard.unmatched_voters.total }}</h4>
        </div>
    </a>
</div>

<!-- More Stats (Collapsible) -->
<div class="mb-4">
    <a class="text-muted small" data-toggle="collapse" href="#moreStatsCollapse" role="button" aria-expanded="false">
        <i class="fas fa-chevron-down"></i> More Stats
    </a>
    <div class="collapse" id="moreStatsCollapse">
        <div class="dashboard-row mt-2">
            <a href="{{ url_for('filter_view', category='empty_seats') }}" class="dash-card dash-card-size dash-card-link">
                <div class="card-header">Empty Seats</div>
                <div class="card-body">
                    <h4>{{ dashboard.empty_seats.total }}</h4>
                </div>
            </a>
            <a href="{{ url_for('filter_view', category='incumbents_running') }}" class="dash-card dash-card-size dash-card-link">
                <div class="card-header">Incumbents Running</div>
                <div class="card-body">
                    <h4>{{ dashboard.incumbents_running.total }}</h4>
                </div>
            </a>
            <a href="{{ url_for('filter_view', category='incumbents_not_running') }}" class="dash-card dash-card-size dash-card-link">
                <div class="card-header">Incumbents Not Running</div>
                <div class="card-body">
                    <h4>{{ dashboard.incumbents_not_running.total }}</h4>
                </div>
            </a>
            <div class="dash-card dash-card-size dash-card-static">
                <div class="card-header">Total Seats</div>
                <div class="card-body">
                    <h4>{{ dashboard.TOTAL_SEATS }}</h4>
                </div>
            </div>
            <div class="dash-card dash-card-size dash-card-static">
                <div class="card-header">Total Districts</div>
                <div class="card-body">
                    <h4>{{ dashboard.TOTAL_DISTRICTS }}</h4>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- County Progress Modal -->
<div class="modal fade" id="countyProgressModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #495057;">
                <h5 class="modal-title text-white"><i class="fas fa-chart-bar"></i> County Progress</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div class="row">
                    {% for county_name, stats in county_stats.items()|sort %}
                    {% set pct = (stats.c2026_confirmed / stats.total_seats * 100)|round|int if stats.total_seats > 0 else 0 %}
                    {% set needs = stats.total_seats - stats.c2026_confirmed %}
                    <div class="col-md-6 mb-3">
                        <a href="{{ url_for('index', county=county_name) }}" class="county-progress-link d-block text-decoration-none" data-dismiss="modal">
                            <div class="d-flex justify-content-between mb-1">
                                <strong class="text-dark">{{ county_name }}</strong>
                                <span class="text-muted">{{ stats.c2026_confirmed }}/{{ stats.total_seats }}{% if needs > 0 %} <small class="text-danger">({{ needs }})</small>{% endif %}</span>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar {% if pct >= 75 %}bg-success{% elif pct >= 50 %}bg-info{% elif pct >= 25 %}bg-warning{% else %}bg-danger{% endif %}"
                                    style="width: {{ pct }}%;">
                                    {{ pct }}%
                                </div>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search Box -->
<form method="GET" action="{{ url_for('index') }}" class="search-box mb-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <input type="text" name="search" class="form-control" placeholder="Search by name or district..." value="{{ search_query or '' }}">
    <button type="submit" class="btn btn-dark">
        <i class="fas fa-search"></i>
    </button>
    {% if search_query %}
    <a href="{{ url_for('index') }}" class="btn btn-outline-dark">Clear</a>
    {% endif %}
</form>

{% if search_query %}
<div class="alert alert-info">
    Showing results for "<strong>{{ search_query }}</strong>" 
    <a href="{{ url_for('index') }}" class="float-right">Clear search</a>
</div>
{% endif %}

<!-- Expand/Collapse All Buttons -->
<div class="mb-3">
    <button type="button" class="btn btn-outline-dark btn-sm" onclick="expandAll()">
        <i class="fas fa-expand-alt"></i> Expand All
    </button>
    <button type="button" class="btn btn-outline-dark btn-sm" onclick="collapseAll()">
        <i class="fas fa-compress-alt"></i> Collapse All
    </button>
</div>

<!-- County Accordion -->
<div id="countyAccordion">
    {% for county_name, dist_dict in county_groups.items()|sort %}
    <div class="card county-card" id="{{ county_name|replace(' ', '_') }}">
        <div class="card-header" data-toggle="collapse" data-target="#collapse-{{ county_name|replace(' ', '_') }}" 
             aria-expanded="false" aria-controls="collapse-{{ county_name|replace(' ', '_') }}">
            <h4>{{ county_name|title }}</h4>
            <small>{{ county_stats[county_name].c2026_confirmed }} / {{ county_stats[county_name].total_seats }} Seats</small>
        </div>
        <div id="collapse-{{ county_name|replace(' ', '_') }}" class="collapse{% if search_query %} show{% endif %}">
            <div class="card-body">
                {% for fdc, info in dist_dict.items() %}
                {% set active_2026 = info.cand2026|rejectattr("status","equalto","Declined")|list %}
                {% set active_2024 = info.cand2024|rejectattr("status","equalto","Declined")|list %}
                {% set a2026 = active_2026|length %}
                {% set a2024 = active_2024|length %}
                {% set seat_count = info.seat_count %}

                {% set status = 'Empty' %}
                {% if a2026 > 0 and a2026 < seat_count %}
                    {% set status = 'Partial' %}
                {% elif a2026 >= seat_count %}
                    {% set status = 'Full' %}
                {% endif %}

                <div class="card district-card">
                    <div class="card-header" data-toggle="collapse" 
                         data-target="#collapse-dist-{{ county_name|replace(' ', '_') }}-{{ loop.index }}"
                         aria-expanded="{% if search_query %}true{% else %}false{% endif %}">
                         <h5>{{ fdc }} ({{ seat_count }} seat{{ 's' if seat_count != 1 else '' }}){% if info.pvi is not none %} <span class="badge" style="font-size: 0.7em; {% if info.pvi_rating == 'SAFE GOP' %}background-color: #8B0000; color: white;{% elif info.pvi_rating == 'LIKELY GOP' %}background-color: #DC143C; color: white;{% elif info.pvi_rating == 'LEAN GOP' %}background-color: #FF6B6B; color: white;{% elif info.pvi_rating == 'SWING' %}background-color: #FFD700; color: black;{% elif info.pvi_rating == 'LEAN DEM' %}background-color: #87CEEB; color: black;{% elif info.pvi_rating == 'LIKELY DEM' %}background-color: #4169E1; color: white;{% elif info.pvi_rating == 'SAFE DEM' %}background-color: #00008B; color: white;{% else %}background-color: #6c757d; color: white;{% endif %}">{% if info.pvi > 0 %}+{% endif %}{{ info.pvi }}%</span>{% endif %}</h5>                        <small>{{ a2026 }}/{{ seat_count }} - {{ status }}</small>
                    </div>
                    <div id="collapse-dist-{{ county_name|replace(' ', '_') }}-{{ loop.index }}" 
                         class="collapse{% if search_query %} show{% endif %}">
                        <div class="card-body">
                            <p class="text-muted small mb-2"><strong>Towns:</strong> {{ info.towns|join(", ") }}</p>
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th style="width:10%">Seat</th>
                                            <th style="width:45%">2026 Candidate</th>
                                            <th style="width:45%">2024 Candidate</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in range(max(seat_count, a2026)) %}
                                        <tr>
                                            <td>{% if row < seat_count %}{{ row + 1 }}{% endif %}</td>
                                            <td>
                                                {% if row < a2026 %}
                                                    {% set cand = active_2026[row] %}
                                                    <a href="{{ url_for('edit_candidate', candidate_id=cand.candidate_id, election_year=2026) }}"
                                                       class="candidate-link
                                                        {% if cand.status|upper == 'CONFIRMED' %}text-success
                                                        {% elif cand.status|upper in ['CONSIDERING','POTENTIAL'] %}text-warning
                                                        {% elif cand.status|upper == 'NEW RECRUIT' %}text-primary
                                                        {% else %}text-secondary{% endif %}">
                                                        {{ cand.name|title }} ({{ cand.status }})
                                                    </a>
                                                    <button type="button" class="btn btn-outline-dark btn-sm ml-1 d-none d-md-inline-block"
                                                            data-toggle="popover" data-candidate-id="{{ cand.candidate_id }}">
                                                        <i class="fas fa-info-circle"></i>
                                                    </button>
                                                {% else %}
                                                    <button class="btn btn-sm btn-outline-dark"
                                                            onclick="openAddCandidateModal('{{ fdc }}', 2026)">
                                                        + Add
                                                    </button>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if row < a2024 %}
                                                    {% set cand = active_2024[row] %}
                                                    <a href="{{ url_for('edit_candidate', candidate_id=cand.candidate_id, election_year=2024) }}"
                                                       class="candidate-link
                                                        {% if cand.status|upper == 'CONFIRMED' %}text-success
                                                        {% elif cand.status|upper in ['CONSIDERING','POTENTIAL'] %}text-warning
                                                        {% elif cand.status|upper == 'NEW RECRUIT' %}text-primary
                                                        {% else %}text-secondary{% endif %}">
                                                        {{ cand.name|title }} ({{ cand.status }})
                                                    </a>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% if a2026 >= seat_count %}
                                        <tr>
                                            <td></td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-dark"
                                                        onclick="openAddCandidateModal('{{ fdc }}', 2026)">
                                                    + Add Another
                                                </button>
                                            </td>
                                            <td></td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                            {% if info.cand2026|selectattr("status","equalto","Declined")|list or info.cand2024|selectattr("status","equalto","Declined")|list %}
                            <p class="text-muted small mt-2 mb-0">
                                <strong>Declined:</strong>
                                {% if info.cand2026|selectattr("status","equalto","Declined")|list %}
                                    2026: {{ info.cand2026|selectattr("status","equalto","Declined")|map(attribute='name')|map('title')|join(', ') }}
                                {% endif %}
                                {% if info.cand2024|selectattr("status","equalto","Declined")|list %}
                                    {% if info.cand2026|selectattr("status","equalto","Declined")|list %}| {% endif %}
                                    2024: {{ info.cand2024|selectattr("status","equalto","Declined")|map(attribute='name')|map('title')|join(', ') }}
                                {% endif %}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}