{% extends "base.html" %}
{% block content %}
<div class="mb-4">
    <a href="{{ url_for('private.speaker_votes') }}" class="text-muted">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>
</div>

{# candidate: candidate_id, first_name, last_name, email, phone1, address, city, zip, district_code, incumbent, tracking_id, commitment_status, confidence_level, notes, last_contact_at #}

<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    {{ candidate[1] }} {{ candidate[2] }}
                    {% if candidate[9] %}<span class="badge badge-dark ml-2">Incumbent</span>{% endif %}
                </h5>
                {% set status = candidate[11] or 'unknown' %}
                <span class="badge badge-{% if status == 'committed' %}success{% elif status == 'leaning_yes' %}info{% elif status == 'opposed' %}danger{% elif status == 'leaning_no' %}warning{% else %}secondary{% endif %}" style="font-size: 1rem;">
                    {{ status|replace('_', ' ')|title }}
                </span>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong>District:</strong><br>
                        {{ candidate[8] or 'Unknown' }}
                    </div>
                    <div class="col-md-4">
                        <strong>Contact:</strong><br>
                        {% if candidate[3] %}<a href="mailto:{{ candidate[3] }}">{{ candidate[3] }}</a><br>{% endif %}
                        {% if candidate[4] %}{{ candidate[4] }}{% endif %}
                    </div>
                    <div class="col-md-4">
                        <strong>Confidence:</strong><br>
                        {% set conf = candidate[12] or 5 %}
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-{% if conf >= 7 %}success{% elif conf >= 4 %}warning{% else %}danger{% endif %}"
                                 style="width: {{ conf * 10 }}%">{{ conf }}/10</div>
                        </div>
                    </div>
                </div>
                {% if candidate[5] or candidate[6] %}
                <div class="row mb-3">
                    <div class="col-md-12">
                        <strong>Address:</strong><br>
                        {{ candidate[5] }}{% if candidate[6] %}, {{ candidate[6] }}{% endif %}{% if candidate[7] %} {{ candidate[7] }}{% endif %}
                    </div>
                </div>
                {% endif %}
                {% if candidate[13] %}
                <div class="alert alert-light">
                    <strong>Notes:</strong> {{ candidate[13] }}
                </div>
                {% endif %}
                <p class="text-muted mb-0">
                    <small>Last contact: {{ candidate[14].strftime('%m/%d/%Y %I:%M %p') if candidate[14] else 'Never' }}</small>
                </p>
            </div>
        </div>

        <!-- Log Contact -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-phone"></i> Log Contact
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('private.log_speaker_contact', candidate_id=candidate[0]) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Contact Method</label>
                                <select name="contact_method" class="form-control">
                                    <option value="phone">Phone Call</option>
                                    <option value="in_person">In Person</option>
                                    <option value="text">Text Message</option>
                                    <option value="email">Email</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Outcome</label>
                                <select name="outcome" class="form-control">
                                    <option value="positive">Positive</option>
                                    <option value="neutral">Neutral</option>
                                    <option value="negative">Negative</option>
                                    <option value="no_answer">No Answer</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>New Status</label>
                                {% set current_status = candidate[11] or 'unknown' %}
                                <select name="new_status" class="form-control">
                                    <option value="unknown" {% if current_status == 'unknown' %}selected{% endif %}>Unknown</option>
                                    <option value="committed" {% if current_status == 'committed' %}selected{% endif %}>Committed</option>
                                    <option value="leaning_yes" {% if current_status == 'leaning_yes' %}selected{% endif %}>Leaning Yes</option>
                                    <option value="leaning_no" {% if current_status == 'leaning_no' %}selected{% endif %}>Leaning No</option>
                                    <option value="opposed" {% if current_status == 'opposed' %}selected{% endif %}>Opposed</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea name="notes" class="form-control" rows="2" placeholder="What was discussed..."></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Confidence (1-10)</label>
                                {% set conf = candidate[12] or 5 %}
                                <select name="confidence_level" class="form-control">
                                    {% for i in range(1, 11) %}
                                    <option value="{{ i }}" {% if conf == i %}selected{% endif %}>{{ i }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Log Contact
                    </button>
                </form>
            </div>
        </div>

        <!-- Contact History -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-history"></i> Contact History
            </div>
            {% if contacts %}
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Method</th>
                            <th>Outcome</th>
                            <th>Status Change</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for contact in contacts %}
                        <tr>
                            <td>{{ contact[3].strftime('%m/%d/%y %I:%M%p') if contact[3] else '' }}</td>
                            <td>{{ contact[4]|title if contact[4] else '' }}</td>
                            <td>
                                <span class="badge badge-{% if contact[5] == 'positive' %}success{% elif contact[5] == 'negative' %}danger{% else %}secondary{% endif %}">
                                    {{ contact[5]|title if contact[5] else '' }}
                                </span>
                            </td>
                            <td>
                                {% if contact[7] != contact[8] %}
                                {{ contact[7]|replace('_', ' ')|title }} â†’ {{ contact[8]|replace('_', ' ')|title }}
                                {% else %}
                                <span class="text-muted">No change</span>
                                {% endif %}
                            </td>
                            <td><small>{{ contact[6] or '' }}</small></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="card-body text-center text-muted">
                <p>No contact history yet.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card bg-light">
            <div class="card-header">
                <i class="fas fa-info-circle"></i> Quick Update
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('private.update_speaker_vote', candidate_id=candidate[0]) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <div class="form-group">
                        <label>Status</label>
                        {% set current_status = candidate[11] or 'unknown' %}
                        <select name="commitment_status" class="form-control">
                            <option value="unknown" {% if current_status == 'unknown' %}selected{% endif %}>Unknown</option>
                            <option value="committed" {% if current_status == 'committed' %}selected{% endif %}>Committed</option>
                            <option value="leaning_yes" {% if current_status == 'leaning_yes' %}selected{% endif %}>Leaning Yes</option>
                            <option value="leaning_no" {% if current_status == 'leaning_no' %}selected{% endif %}>Leaning No</option>
                            <option value="opposed" {% if current_status == 'opposed' %}selected{% endif %}>Opposed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Confidence</label>
                        {% set conf = candidate[12] or 5 %}
                        <select name="confidence_level" class="form-control">
                            {% for i in range(1, 11) %}
                            <option value="{{ i }}" {% if conf == i %}selected{% endif %}>{{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea name="notes" class="form-control" rows="3">{{ candidate[13] or '' }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-block btn-primary">Update</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
