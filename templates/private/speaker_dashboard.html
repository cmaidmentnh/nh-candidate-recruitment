{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0"><i class="fas fa-gavel"></i> Speaker Votes</h1>
</div>

<div class="alert alert-secondary py-2 mb-3">
    <i class="fas fa-lock"></i> <strong>Private:</strong> Jason Osborne for Speaker
</div>

<!-- Summary Cards -->
<div class="dashboard-row mb-4">
    <div class="dash-card dash-card-size" style="border-left: 4px solid #28a745;">
        <div class="card-header">Committed</div>
        <div class="card-body"><h4>{{ status_counts.get('committed', 0) }}</h4></div>
    </div>
    <div class="dash-card dash-card-size" style="border-left: 4px solid #17a2b8;">
        <div class="card-header">Leaning Yes</div>
        <div class="card-body"><h4>{{ status_counts.get('leaning_yes', 0) }}</h4></div>
    </div>
    <div class="dash-card dash-card-size" style="border-left: 4px solid #6c757d;">
        <div class="card-header">Unknown</div>
        <div class="card-body"><h4>{{ status_counts.get('unknown', 0) }}</h4></div>
    </div>
    <div class="dash-card dash-card-size" style="border-left: 4px solid #ffc107;">
        <div class="card-header">Leaning No</div>
        <div class="card-body"><h4>{{ status_counts.get('leaning_no', 0) }}</h4></div>
    </div>
    <div class="dash-card dash-card-size" style="border-left: 4px solid #dc3545;">
        <div class="card-header">Opposed</div>
        <div class="card-body"><h4>{{ status_counts.get('opposed', 0) }}</h4></div>
    </div>
</div>

<!-- Legislators List -->
<div class="card">
    <div class="card-header py-2">
        <strong>{{ legislators|length }}</strong> R Incumbents
    </div>
    <div class="list-group list-group-flush">
        {% for leg in legislators %}
        {# leg: candidate_id, first_name, last_name, email, phone1, district_code, incumbent, tracking_id, commitment_status, confidence_level, notes, last_contact_at #}
        {% set status = leg[8] or 'unknown' %}
        <div class="list-group-item leg-item" data-status="{{ status }}">
            <form method="POST" action="{{ url_for('private.update_speaker_vote', candidate_id=leg[0]) }}" id="form-{{ leg[0] }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="row align-items-center">
                    <!-- Name & Contact -->
                    <div class="col-12 col-md-3 mb-2 mb-md-0">
                        <a href="{{ url_for('private.speaker_vote_detail', candidate_id=leg[0]) }}" class="leg-name">
                            <strong>{{ leg[1] }} {{ leg[2] }}</strong>
                        </a>
                        <span class="text-muted d-none d-md-inline ml-2">{{ leg[5] }}</span>
                        <div class="d-md-none text-muted small">{{ leg[5] }}</div>
                        <div class="mt-1">
                            {% if leg[4] %}
                            <a href="tel:{{ leg[4] }}" class="contact-btn" title="Call {{ leg[4] }}"><i class="fas fa-phone"></i></a>
                            <a href="sms:{{ leg[4] }}" class="contact-btn" title="Text {{ leg[4] }}"><i class="fas fa-comment"></i></a>
                            {% endif %}
                            {% if leg[3] %}
                            <a href="mailto:{{ leg[3] }}" class="contact-btn" title="Email {{ leg[3] }}"><i class="fas fa-envelope"></i></a>
                            {% endif %}
                            <button type="button" class="contact-btn" title="Log Contact" data-toggle="modal" data-target="#logModal{{ leg[0] }}"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="col-6 col-md-2 mb-2 mb-md-0">
                        <select name="commitment_status" class="form-control form-control-sm" onchange="document.getElementById('form-{{ leg[0] }}').submit()">
                            <option value="committed" {% if status == 'committed' %}selected{% endif %}>Committed</option>
                            <option value="leaning_yes" {% if status == 'leaning_yes' %}selected{% endif %}>Leaning Yes</option>
                            <option value="unknown" {% if status == 'unknown' %}selected{% endif %}>Unknown</option>
                            <option value="leaning_no" {% if status == 'leaning_no' %}selected{% endif %}>Leaning No</option>
                            <option value="opposed" {% if status == 'opposed' %}selected{% endif %}>Opposed</option>
                        </select>
                    </div>

                    <!-- Confidence -->
                    <div class="col-6 col-md-1 mb-2 mb-md-0">
                        <select name="confidence_level" class="form-control form-control-sm" onchange="document.getElementById('form-{{ leg[0] }}').submit()">
                            {% for i in range(1, 11) %}
                            <option value="{{ i }}" {% if (leg[9] or 5) == i %}selected{% endif %}>{{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Notes -->
                    <div class="col-12 col-md-6">
                        <div class="input-group input-group-sm">
                            <input type="text" name="notes" class="form-control" value="{{ leg[10] or '' }}" placeholder="Notes...">
                            <div class="input-group-append">
                                <button type="submit" class="btn btn-outline-secondary"><i class="fas fa-save"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Log Contact Modal -->
        <div class="modal fade" id="logModal{{ leg[0] }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form method="POST" action="{{ url_for('private.log_speaker_contact', candidate_id=leg[0]) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="modal-header py-2">
                            <h5 class="modal-title">Log Contact - {{ leg[1] }} {{ leg[2] }}</h5>
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-6">
                                    <div class="form-group">
                                        <label>Method</label>
                                        <select name="contact_method" class="form-control">
                                            <option value="phone">Phone</option>
                                            <option value="in_person">In Person</option>
                                            <option value="text">Text</option>
                                            <option value="email">Email</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-group">
                                        <label>Outcome</label>
                                        <select name="outcome" class="form-control">
                                            <option value="positive">Positive</option>
                                            <option value="neutral">Neutral</option>
                                            <option value="negative">Negative</option>
                                            <option value="no_answer">No Answer</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="form-group">
                                        <label>New Status</label>
                                        <select name="new_status" class="form-control">
                                            <option value="committed" {% if status == 'committed' %}selected{% endif %}>Committed</option>
                                            <option value="leaning_yes" {% if status == 'leaning_yes' %}selected{% endif %}>Leaning Yes</option>
                                            <option value="unknown" {% if status == 'unknown' %}selected{% endif %}>Unknown</option>
                                            <option value="leaning_no" {% if status == 'leaning_no' %}selected{% endif %}>Leaning No</option>
                                            <option value="opposed" {% if status == 'opposed' %}selected{% endif %}>Opposed</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-group">
                                        <label>Confidence</label>
                                        <select name="confidence_level" class="form-control">
                                            {% for i in range(1, 11) %}
                                            <option value="{{ i }}" {% if (leg[9] or 5) == i %}selected{% endif %}>{{ i }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea name="notes" class="form-control" rows="2" placeholder="What was discussed..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer py-2">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Log Contact</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<style>
.contact-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #e9ecef;
    color: #495057;
    border: none;
    margin-right: 4px;
    text-decoration: none;
    transition: background 0.15s;
    cursor: pointer;
}
.contact-btn:hover {
    background: #dee2e6;
    color: #212529;
    text-decoration: none;
}
.contact-btn i { font-size: 12px; }
.leg-name { color: inherit; text-decoration: none; }
.leg-name:hover { color: #007bff; text-decoration: none; }
.leg-item { border-left: 3px solid #6c757d; }
.leg-item[data-status="committed"] { border-left-color: #28a745; }
.leg-item[data-status="leaning_yes"] { border-left-color: #17a2b8; }
.leg-item[data-status="leaning_no"] { border-left-color: #ffc107; }
.leg-item[data-status="opposed"] { border-left-color: #dc3545; }
</style>
{% endblock %}
